<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">

    <title>COVID-19 Dashboard</title>

    <!-- Load the Chart.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js"></script>
    <!--DATATABLES-->
    <script src="https://code.jquery.com/jquery-1.12.3.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.21/css/jquery.dataTables.css">
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.js"></script>
    <script src="https://cdn.datatables.net/plug-ins/1.10.21/features/pageResize/dataTables.pageResize.min.js"></script>

    <!--CSS templates-->
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'dashboard/layout.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'dashboard/datatables.css' %}">

    <!--ARCGIS-->
    <link rel="stylesheet" href="https://js.arcgis.com/4.15/esri/themes/light/main.css">
    <script src="https://js.arcgis.com/4.15/"></script>




    <script>

        const HOST_NAME = "http://localhost:8000"

        function isMobileDevice() {
            return (typeof window.orientation !== "undefined") || (navigator.userAgent.indexOf('IEMobile') !== -1);
        }

        let table;

        require([
            "esri/Map",
            "esri/views/MapView",
            "esri/geometry/Extent",
            "esri/layers/FeatureLayer",
            "esri/layers/GeoJSONLayer",
            "esri/renderers/DotDensityRenderer",
            "esri/renderers/SimpleRenderer",
            "esri/Graphic",
            "esri/geometry/support/webMercatorUtils",
            "esri/widgets/Home",
            "esri/widgets/Legend",
            "esri/widgets/Expand",
            "esri/widgets/Fullscreen",
            "esri/widgets/Search",
            "esri/widgets/BasemapGallery",
        ], function(Map,
                    MapView,
                    Extent,
                    FeatureLayer,
                    GeoJSONLayer,
                    DotDensityRenderer,
                    SimpleRenderer,
                    Graphic,
                    webMercatorUtils,
                    Home,
                    Legend,
                    Expand,
                    Fullscreen,
                    Search,
                    BasemapGallery,) {


            // //////////
            // DATA fetch
            // //////////

            const urlGeoJSON = HOST_NAME + "/dashboard/api/get-points/"
            const QuerySettings = {
                url: urlGeoJSON,
                method: "GET",
                success: function (data) {
                    populateDataTable(JSON.parse(data));

                    const blob = new Blob([(data)], {type: "application/json"});
                    const urlLayer  = URL.createObjectURL(blob);
                    createMap(urlLayer);
                },
                error: function (e) {
                    console.log("There was an error with your request...");
                    console.log("error: " + JSON.stringify(e));
                }
            };

            $.ajax(QuerySettings);


            // /////////////////
            // Create data table
            // /////////////////

            function populateDataTable(data) {

                table = $('#side-table').DataTable( {
                    data: data.features,
                    columns: [
                        {
                            data: "properties.date_test",
                            render: function ( data, type, row ) {
                                const dateSplit = data.split('T')[0].split('-');
                                return type === "display" || type === "filter" ?
                                    dateSplit[2] +'-'+ dateSplit[1] +'-'+ dateSplit[0] :
                                    data;
                            }
                        },
                        {
                            data: "properties.test_result",
                            // render: function (data, type, row){
                            //     switch(data) {
                            //         case "True":
                            //             return "Positive";
                            //         case "False":
                            //             return "Negative";
                            //         default:
                            //             return "n/a";
                            //     }
                            // }
                        },
                        {
                            data: "properties.testing_centre__centre_type",
                            // render: function (data, type, row){
                            //     switch(data) {
                            //         case "HOSP":
                            //             return "Hospital";
                            //         case "CLIN":
                            //             return "GP Clinic";
                            //         case "DRIV":
                            //             return "Drive through";
                            //         case "HOME":
                            //             return "Home test";
                            //         case "OTHR":
                            //             return "Other";
                            //         default:
                            //             return "n/a";
                            //     }
                            // }
                        },
                        { data: "properties.testing_centre__postcode" },

                    ],
                    pageResize: true,
                    rowId: 'properties.pk',
                });



            };


            // /////////////////////
            // Create map and layers
            // /////////////////////

            function createMap(geoJSONLayerURL) {
                ///////////
                // Map view

                const map = new Map({
                    basemap: "gray-vector"
                });

                const baseMap = new MapView({
                    container: "viewDiv",
                    map: map,
                    center: [-2.89479, 54.093409],
                    zoom: 5,
                    highlightOptions: {
                        color: [255, 255, 0, 1],
                        haloOpacity: 0.9,
                        fillOpacity: 0.2
                    },
                });


                baseMap
                    .when(function() {
                        // View successfully loaded, show viewDiv
                        document.getElementById("viewDiv").style.display = "flex";
                    })
                    .catch(function(error) {
                        if (error.name.includes("webgl")) {
                            // View was rejected, show webgl unsupported message and turn off the viewDiv
                            const divs = document.getElementsByTagName("div");
                            for (let i = 0; i < divs.length; i++) {
                                divs[i].style.display = 'none';
                            }
                            const webglDiv = document.getElementById("webglNotSupportedDiv");
                            webglDiv.innerHTML = error.message;
                            webglDiv.style.display = "flex";
                            webglDiv.style.visibility = "visible";
                        }
                    });


                /////////////
                // DATA LAYER

                // heatmap renderer
                const heatRenderer = {
                    type: "heatmap",
                    colorStops: [
                        {color: "rgba(63, 40, 102, 0)", ratio: 0},
                        {color: "#e5ff00", ratio: 0.083},
                        {color: "#fff700", ratio: 0.166},
                        {color: "#ffdd00", ratio: 0.249},
                        {color: "#ffd500", ratio: 0.332},
                        {color: "#ffc400", ratio: 0.415},
                        {color: "#ffb300", ratio: 0.498},
                        {color: "#ff9d00", ratio: 0.581},
                        {color: "#ff8400", ratio: 0.664},
                        {color: "#ff5e00", ratio: 0.747},
                        {color: "#ff3c00", ratio: 0.83},
                        {color: "#ff2200", ratio: 0.913},
                        {color: "#ff0000", ratio: 1}
                    ],
                    maxPixelIntensity: 1000,
                    minPixelIntensity: 0,
                };

                var dotRenderer = {
                    type: "unique-value",
                    field: "test_result",
                    defaultSymbol: {
                        type: "simple-marker",
                        color: "orange",
                        size: 8,
                        outline:{
                            style: "none",
                        },
                    },
                    defaultLabel: "n/a",
                    uniqueValueInfos: [{
                        value: "Positive",
                        symbol: {
                            type: "simple-marker",
                            color: "rgba(255, 0, 0, 1)",
                            size: 8,
                            outline:{
                                style: "none",
                            },
                        },
                        label: "Positive"
                    }, {
                        value: "Negative",
                        symbol: {
                            type: "simple-marker",
                            color: "rgba(0, 255, 0, 1)",
                            size: 8,
                            outline: {
                                style: "none",
                            },
                        },
                        label: "Negative",
                    },],
                    outline:{
                        style: "none",
                    },
                };

                // POPUP FOR DATA LAYER
                const template = {
                    title: "Test Information:",
                    content: "Test result: {test_result} <br> Test date: {date_test} <br> Centre type: {testing_centre__centre_type} <br> Postcode: {testing_centre__postcode}",
                };

                // create data layer
                const geoJSONLayer = new GeoJSONLayer({
                    url: geoJSONLayerURL,
                    copyright: "Add copyright for COVID data if needed",
                    renderer: heatRenderer,
                    title: "COVID-19 testing",
                    popupTemplate: template,
                    // featureReduction : {
                    //     type: "cluster",
                    //     clusterRadius: 10,
                    //     popupTemplate: {
                    //         content: "This cluster represents {cluster_count} diagnostic tests."
                    //     }
                    // },
                });

                geoJSONLayer.popup = {
                    dockEnabled: true,
                    dockOptions: {
                        buttonEnabled: false,
                        breakpoint: false
                    },
                };

                /////////
                // Select which dots to display
                function updateRenderer(color, index) {
                    let renderer = geoJSONLayer.renderer.clone();
                    if (index === -1) {
                        renderer.defaultSymbol.color = color;
                    }
                    else{
                        renderer.uniqueValueInfos[index].symbol.color = color;
                    }
                    geoJSONLayer.renderer = renderer;
                }

                const PositiveToggle = document.getElementById("positiveDots");
                const NegativeToggle = document.getElementById("negativeDots");
                const OtherToggle = document.getElementById("otherDots");
                PositiveToggle.addEventListener("change", function () {
                    if (PositiveToggle.checked) updateRenderer("rgba(255, 0, 0, 1)", 0);
                    else updateRenderer("rgba(255, 0, 0, 0)", 0);
                });
                NegativeToggle.addEventListener("change", function () {
                    if (NegativeToggle.checked) updateRenderer("rgba(0, 255, 0, 1)", 1);
                    else updateRenderer("rgba(0, 255, 0, 0)", 1);
                });
                OtherToggle.addEventListener("change", function () {
                    if (OtherToggle.checked) updateRenderer("rgba(255, 165, 0, 1)", -1);
                    else updateRenderer("rgba(255, 165, 0, 0)", -1);
                });

                //renderer selection w/ radio
                let radios = document.getElementsByName("renderer");
                let renderArray = [heatRenderer, dotRenderer];
                for (let i = 0; i < radios.length; i++) {
                    radios[i].addEventListener("change", function (event) {
                        const fieldName = event.target.value;
                        if (fieldName === "HEAT") {
                            renderArray[1] = geoJSONLayer.renderer.clone();
                            $("#dotsCheckboxSettings").hide('slow');
                            geoJSONLayer.renderer = renderArray[0];
                        }
                        if (fieldName === "DOTS") {
                            renderArray[0] = geoJSONLayer.renderer.clone();
                            $("#dotsCheckboxSettings").show('slow');
                            geoJSONLayer.renderer = renderArray[1];
                        }
                    });
                }

                // ////////////
                // Postcode Map

                //renderer
                const lineRenderer = {
                    type: "simple",

                    symbol: {
                        type: "simple-fill",
                        style: "none",
                        outline: {
                            width: 0.1,
                            color: [0, 0, 0, 0.4],
                        },
                    },
                    label: "Postcode Sector Boundaries"
                };
                let centreChart;
                function createCentreChart() {
                    const centreCanvas = document.getElementById("centre-chart");
                    centreChart = new Chart(centreCanvas.getContext("2d"), {
                        type: "doughnut",
                        data: {
                            labels: ["Home", "Hospital", "GP Clinic", "Drive Through", "Other"],
                            datasets: [
                                {
                                    backgroundColor: [
                                        "#FD7F6F",
                                        "#7EB0D5",
                                        "#B2E061",
                                        "#BD7EBE",
                                        "#FFB55A"
                                    ],
                                    borderWidth: 0,
                                    data: [0, 0, 0, 0, 0]
                                }
                            ]
                        },
                        options: {
                            responsive: false,
                            cutoutPercentage: 35,
                            legend: {
                                position: "bottom"
                            },
                            title: {
                                display: true,
                                text: "Centre Type"
                            }
                        }
                    });
                }


                createCentreChart();



                function updateChart(chart, dataValues) {
                    chart.data.datasets[0].data = dataValues;
                    chart.update();
                }
                // postcode map and popup
                function queryPopup(target) {
                    const query = geoJSONLayer.createQuery();
                    query.geometry = target.graphic.geometry;
                    query.outStatistics = [

                        {
                            onStatisticField:
                                "CASE WHEN test_result = 'Positive' THEN 1 ELSE 0 END",
                            outStatisticFieldName: "positive",
                            statisticType: "sum"
                        },
                        {
                            onStatisticField:
                                "CASE WHEN test_result = 'Negative' THEN 1 ELSE 0 END",
                            outStatisticFieldName: "negative",
                            statisticType: "sum"
                        },
                        {
                            onStatisticField:
                                "CASE WHEN testing_centre__centre_type = 'Hospital' THEN 1 ELSE 0 END",
                            outStatisticFieldName: "hospital",
                            statisticType: "sum"
                        },
                        {
                            onStatisticField:
                                "CASE WHEN testing_centre__centre_type = 'Other' THEN 1 ELSE 0 END",
                            outStatisticFieldName: "other",
                            statisticType: "sum"
                        },
                        {
                            onStatisticField:
                                "CASE WHEN testing_centre__centre_type = 'GP clinic' THEN 1 ELSE 0 END",
                            outStatisticFieldName: "clinic",
                            statisticType: "sum"
                        },
                        {
                            onStatisticField:
                                "CASE WHEN testing_centre__centre_type = 'Drive through centre' THEN 1 ELSE 0 END",
                            outStatisticFieldName: "drive_through",
                            statisticType: "sum"
                        },
                        {
                            onStatisticField:
                                "CASE WHEN testing_centre__centre_type = 'Home' THEN 1 ELSE 0 END",
                            outStatisticFieldName: "home",
                            statisticType: "sum"
                        },

                    ];

                    let tmp=geoJSONLayer.queryFeatures(query).then(function(response) {
                        let data = response.features[0].attributes;


                        updateChart(centreChart, [
                            data.home,
                            data.other,
                            data.hospital,
                            data.clinic,
                            data.drive_through,
                        ]);




                        console.log("Statistics: ", response.features[0].attributes)
                        let  tmp = ("<table> <tbody>" +
                            "<tr> <td style=\"padding:0 15px 0 0;\">Total tests:</td> <td>" +  ((data.positive + data.negative) || 0) + "</td> </tr>" +
                            "<tr> <td>Positive:</td> <td>" + (data.positive || 0) + "</td> </tr>" +
                            "<tr> <td>Negative:</td> <td>" + (data.negative || 0) + "</td> </tr>" +
                            "</tbody> </table>");
                        return tmp;
                    });

                    return tmp;
                }

                // postcode popup
                const popupPostcode = {
                    title: "{NAME_1}, {POSTCODE_1}",
                    content: queryPopup,
                };

                // postcode layer
                let postcodes = new FeatureLayer({
                    url: "https://services.arcgis.com/dvWpUrMTxKmay5qM/arcgis/rest/services/PCSector%20with%20Regions/FeatureServer",
                    outFields: ["POSTCODE_1", "NAME_1",],
                    popupTemplate: popupPostcode,
                    renderer: lineRenderer,
                    title: "Map features",
                    minScale: 300000,
                    maxScale: 0,
                    legendEnabled: false,
                });

                // popup location
                baseMap.popup = {
                    dockEnabled: true,
                    dockOptions: {
                        buttonEnabled: false,
                        breakpoint: false
                    },
                };

                // add postcode layer to map
                map.add(postcodes);


                const countryPopup = {
                    title: "{NAME}",
                    content: queryPopup,
                };

                //renderer
                const countryRenderer = {
                    type: "simple",

                    symbol: {
                        type: "simple-fill",
                        style: "none",
                        outline: {
                            width: 0.1,
                            color: "none",
                        },
                    },
                };


                let countries = new GeoJSONLayer({
                    url:"{% static 'dashboard/countries.geojson' %}",
                    outFields:["*"],
                    popupTemplate: countryPopup,
                    renderer: countryRenderer,
                    title: "Country",
                    minScale: 0,
                    maxScale: 8000000,
                    legendEnabled: false,

                });

                map.add(countries);


                // const areaPopup = {
                //     title: "{NAME}",
                //     content: queryPopup,
                // };
                //
                // let area = new FeatureLayer({
                //     url: "https://services.arcgis.com/P3ePLMYs2RVChkJx/arcgis/rest/services/GBR_Boundaries_2017/FeatureServer/3",
                //     outFields:["OBJECTID","ID","NAME"],
                //     popupTemplate: areaPopup,
                //     renderer: lineRenderer,
                //     title: "Region",
                //     minScale: 8000000,
                //     maxScale: 300000,
                // });
                //
                // map.add(area);

                // const RegionPopupSco = {
                //     title: "{spr16nm}",
                //     content: "{OBJECTID}",
                // };
                //
                // let regionsSco = new FeatureLayer({
                //     url: "https://ons-inspire.esriuk.com/arcgis/rest/services/Electoral_Boundaries/Scottish_Parliamentray_Regions_May_2016_Boundaries/MapServer/0/",
                //     outFields:["OBJECTID","spr16nm"],
                //     popupTemplate: RegionPopupSco,
                //     renderer: lineRenderer,
                //     minScale: 8000000,
                //     maxScale: 300000,
                // });
                //
                // map.add(regionsSco);




                ///////
                //Home button widget to reset view
                const homeWidget = new Home({
                    view: baseMap
                });


                ///////
                // Search widget
                const search = new Search({
                    view: baseMap,
                    locationEnabled: false,
                });


                // Display postcode popup on search
                search.on("select-result", function(event){
                    // get coordinates of searched address
                    const coordinates = webMercatorUtils.xyToLngLat(event.result.feature.geometry.x, event.result.feature.geometry.y);

                    // make apoint out of them
                    let point = {
                        type: "point",
                        x: coordinates[0],
                        y: coordinates[1]
                    };


                    // query the postcode layer to see which poscodes intersect with the point
                    let query = postcodes.createQuery();
                    query.geometry = point;
                    query.spatialRelationship = "intersects";
                    postcodes.queryFeatures(query)
                        .then(function(feature) {

                            // filter by postcode in datatables
                            // comment out if feature not needed
                            table.search(feature.features[0].attributes.POSTCODE_1).draw();

                            // open popup of query result
                            baseMap.popup.open({
                                features: feature.features
                            });
                        });
                });

                // clear datatables search when map search is cleared
                search.on("search-clear", function(event){
                    table.search('').draw();
                });


                ///////
                // fullscreen widget
                const fullscreen = new Fullscreen({
                    view: baseMap
                });


                ///////
                // basemap gallery
                const gallery = new BasemapGallery({
                    view: baseMap,
                });


                ///////
                // postcode map toggle
                const PostcodeToggle = document.getElementById("postcodeLayer");
                PostcodeToggle.addEventListener("change", function () {
                    postcodes.visible = PostcodeToggle.checked;
                });


                // add geoJSON layer to map
                map.add(geoJSONLayer);


                //////////////
                // Highlight map on table select

                let highlightSelect;
                baseMap.whenLayerView(geoJSONLayer).then(function(layerView) {
                    let queryLayer = geoJSONLayer.createQuery();

                    $('#side-table tbody').on( 'click', 'tr', function () {

                        // remove selection if clicking on a selected row
                        if ( table.row(this).node().className.includes('selected')){
                            $(this).removeClass('selected');
                            if (highlightSelect) {
                                highlightSelect.remove();
                            }
                        }
                        // remove old selection and add selection on new row
                        else{
                            $(this).addClass('selected').siblings().removeClass('selected');
                            const id = table.row( this ).id();

                            queryLayer.where = "pk='" + id + "'";
                            geoJSONLayer.queryFeatures(queryLayer).then(function(result) {
                                // if a feature is already highlighted, then remove the highlight
                                if (highlightSelect) {
                                    highlightSelect.remove();
                                }

                                // the feature to be highlighted
                                const feature = result.features[0];

                                // use the objectID to highlight the feature
                                highlightSelect = layerView.highlight(
                                    feature.attributes["OBJECTID"]
                                );
                                // baseMap.popup.selectedFeatureIndex = feature.attributes["OBJECTID"];
                                // baseMap.popup.open(template);


                                // center the feature
                                baseMap
                                    .goTo(
                                        {
                                            target: feature.geometry,
                                            zoom: 15
                                        },
                                        {
                                            duration: 1000,
                                            easing: "in-out-expo"
                                        }
                                    )
                                    .catch(function(error) {
                                        if (error.name != "AbortError") {
                                            console.log(error);
                                        }
                                    });
                            });
                        }
                    });
                });


                // graphs!

                ///////
                // add views and widgets
                baseMap.ui.add("selectionPaneDiv", "bottom-left");
                baseMap.ui.add(fullscreen, "bottom-right");
                baseMap.ui.add(homeWidget, "top-left");
                baseMap.ui.add(search, "top-right");
                baseMap.ui.add(
                    [
                        new Expand({
                            view: baseMap,
                            content: gallery,
                            group: "top-left",
                            expanded: false
                        }),
                    ],
                    "top-left"
                );
                baseMap.ui.add(
                    [
                        new Expand({
                            view: baseMap,
                            content: new Legend({view: baseMap}),
                            group: "top-left",
                            expanded: !(isMobileDevice()),
                        }),
                    ],
                    "top-left"
                );
                baseMap.ui.add(
                    [
                        new Expand({
                            view: baseMap,
                            content: document.getElementById("selectionPaneDiv"),
                            group: "bottom-left",
                            expanded: !(isMobileDevice()),
                        }),
                    ],
                    "bottom-left"
                );

            };
        });

    </script>
</head>
<body>

<div id="viewDiv"></div>

<div id="selectionPaneDiv" class="esri-widget">
    <p>Visualise COVID-19 spread using:</p>
    <label>
        <input type="radio" name="renderer" value="HEAT" checked />
        Heatmap
    </label> <br />

    <label>
        <input type="radio" name="renderer" value="DOTS" />
        Dots
    </label> <br />

    <div id="dotsCheckboxSettings" style="display: none">
        <label>
            <input type="checkbox" id="positiveDots" checked>Show positive test results
        </label>
        <br>
        <label>
            <input type="checkbox" id="negativeDots" checked>Show negative tests results
        </label>
        <br>
        <label>
            <input type="checkbox" id="otherDots" checked>Show inconclusive tests
        </label>
    </div>

    <br />

    <label>
        <input type="checkbox" id="postcodeLayer" checked> Postcode Boundaries
    </label>



</div>

<div id="feature-node-right-top" class="esri-widget">
    <!--    <table id="side-table" class="display" cellspacing="0" width="100%">-->
    <!--        <thead>-->
    <!--        <tr>-->
    <!--            <th>Test Date</th>-->
    <!--            <th>Result</th>-->
    <!--            <th>Centre Type</th>-->
    <!--            <th>Postcode</th>-->
    <!--        </tr>-->
    <!--        </thead>-->
    <!--    </table>-->
    <canvas id="centre-chart" width="250" height="300"></canvas>
</div>

<div id="feature-node-right-bottom" class="esri-widget">


</div>


<div id="webglNotSupportedDiv"></div>


</body>
</html>