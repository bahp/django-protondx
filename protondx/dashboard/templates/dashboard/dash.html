<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">

    <title>COVID-19 Dashboard</title>

    <!-- Load the Chart.js and moment.js libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js"></script>

    <!--Jquery-->
    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>



    <!--DATATABLES-->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.21/css/jquery.dataTables.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.2.4/css/responsive.dataTables.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/1.6.2/css/buttons.dataTables.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.21/css/dataTables.jqueryui.min.css">
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.js"></script>
    <script src="https://cdn.datatables.net/plug-ins/1.10.21/features/pageResize/dataTables.pageResize.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.2.4/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.6.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.6.2/js/buttons.colVis.min.js"></script>

    <!--CSS templates-->
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'dashboard/css/layout.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'dashboard/css/modal-grid.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'dashboard/css/main-grid.css' %}">
    <!--    <link rel="stylesheet" type="text/css" href="{% static 'dashboard/datatable.css' %}">-->

    <!--ARCGIS-->
    <link rel="stylesheet" href="https://js.arcgis.com/4.15/esri/themes/light/main.css">
    <script src="https://js.arcgis.com/4.15/"></script>


    <script>

        const HOST_NAME = "{{ URL_SCHEME }}://{{ HOSTNAME }}";

        function isMobileDevice() {
            return (typeof window.orientation !== "undefined") || (navigator.userAgent.indexOf('IEMobile') !== -1);
        }

        let table;
        let patientTable;
        require([
            "esri/Map",
            "esri/views/MapView",
            "esri/geometry/Extent",
            "esri/layers/FeatureLayer",
            "esri/layers/GeoJSONLayer",
            "esri/renderers/DotDensityRenderer",
            "esri/renderers/SimpleRenderer",
            "esri/Graphic",
            "esri/geometry/support/webMercatorUtils",
            "esri/widgets/Home",
            "esri/widgets/Legend",
            "esri/widgets/Expand",
            "esri/widgets/Fullscreen",
            "esri/widgets/Search",
            "esri/widgets/BasemapGallery",
        ], function(Map,
                    MapView,
                    Extent,
                    FeatureLayer,
                    GeoJSONLayer,
                    DotDensityRenderer,
                    SimpleRenderer,
                    Graphic,
                    webMercatorUtils,
                    Home,
                    Legend,
                    Expand,
                    Fullscreen,
                    Search,
                    BasemapGallery,) {

            // //////////
            // DATA fetch
            // //////////

            const urlGeoJSON = HOST_NAME + "/dashboard/api/get-points/"
            const QuerySettings = {
                url: urlGeoJSON,
                method: "GET",
                success: function (data) {
                    populateDataTable(JSON.parse(data));

                    const blob = new Blob([(data)], {type: "application/json"});
                    const urlLayer  = URL.createObjectURL(blob);
                    createMap(urlLayer);
                },
                error: function (e) {
                    console.log("There was an error with your request...");
                    console.log("error: " + JSON.stringify(e));
                }
            };

            $.ajax(QuerySettings);


            // /////////////////
            // Create data table
            // /////////////////

            function populateDataTable(data) {

                table = $('#side-table').DataTable( {
                    data: data.features,
                    columns: [
                        {
                            data: "properties.patient",
                        },
                        {
                            data: "properties.date_test",
                        },
                        {
                            data: "properties.test_result",
                        },
                        {
                            data: "properties.testing_centre__centre_type",
                        },
                        {
                            data: "properties.testing_centre__postcode"
                        },
                        {
                            data: "properties.testing_centre__county",
                            visible: false,
                        },
                        {
                            data: "properties.testing_centre__region",
                            visible: false,
                        },
                        {
                            data: "properties.testing_centre__country",
                            visible: false,
                        },
                    ],
                    buttons: [
                        'colvis'
                    ],
                    dom: 'Bfrtip',
                    // rowId: 'properties.pk',
                    paging:         false,
                    bLengthChange: false,
                    bInfo: false,
                    deferRender:    true,
                    scrollY:        200,
                    scrollX: "100%",
                });

                patientTable = $('#patient-table').DataTable( {
                    data: {
                        date_test: "",
                        test_result: "",
                        testing_centre: ""
                    },
                    columns: [
                        {
                            data: "date_test",
                        },
                        {
                            data: "test_result",
                        },
                        {
                            data: "centre_type",
                        },
                    ],
                    paging:         false,
                    bLengthChange: false,
                    deferRender:    true,
                    scrollY:        200,
                    scrollX: "100%"
                });


                // Get the modal
                const modal = document.getElementById("myModal");
                const modal_patient_name = document.getElementById("modal-patient-name");
                // Get the <span> element that closes the modal
                const span = document.getElementsByClassName("close")[0];

                const tr_patient_id = document.getElementById("tr-patient-id");
                const tr_patient_gender = document.getElementById("tr-patient-gender");
                const tr_patient_dob = document.getElementById("tr-patient-dob");
                const tr_patient_postcode = document.getElementById("tr-patient-postcode");
                const tr_patient_count = document.getElementById("tr-patient-count");

                $('#side-table tbody').on( 'click', 'tr', function () {
                    const patient_id = table.row( this ).data().properties.patient;
                    const patientURL = HOST_NAME + "/dashboard/api/patient/" + patient_id;
                    const diagnosticsURL = HOST_NAME + "/dashboard/api/diagnostic-test/?patient=" + patient_id;


                    let call1 =  $.get(patientURL);
                    let call2 =  $.get(diagnosticsURL);

                    // catch error!!!
                    $.when(call1, call2).then(function (response1, response2) {

                        // add patient name
                        modal_patient_name.innerHTML = response1[0].first_name + " " + response1[0].last_name;

                        // add patient diagnostic test table
                        patientTable.clear();
                        patientTable.rows.add(response2[0]);

                        // add patient information
                        tr_patient_id.innerText = "# " + patient_id;
                        tr_patient_gender.innerText = response1[0].gender;
                        tr_patient_dob.innerText = response1[0].dob
                            + " ("
                            + moment().diff(moment(response1[0].dob,'DD-MM-YYYY').format('MM-DD-YYYY'), 'years')
                            + ")";
                        tr_patient_postcode.innerText = response1[0].postcode;
                        tr_patient_count.innerText = response2[0].length;

                        // make modal visible
                        modal.style.display = "block";

                        // display table
                        // done after displaying modal for correct column width
                        patientTable.draw();
                    }).catch(function (e) {
                        console.log(e);
                    });
                });

                const pcr_id = document.getElementById("pcr-id");
                const comment_id = document.getElementById("comment-id");
                const comment_body = document.getElementById("comment-body");

                $('#patient-table tbody').on( 'click', 'tr', function () {
                    $(this).addClass('selected').siblings().removeClass('selected');
                    const diagnostic_id = patientTable.row( this ).data().id;

                    pcr_id.innerHTML = diagnostic_id;
                    comment_id.innerHTML = diagnostic_id;

                    const diagnosticDetailURL = HOST_NAME + '/dashboard/api/diagnostic-detail/?id=' + diagnostic_id;
                    let getDetail =  $.get(diagnosticDetailURL);

                    $.when(getDetail).then(function (response) {
                        if (Array.isArray(response)
                            && response.length
                            && 'comment' in response[0]
                            && response[0]['comment']) {

                            comment_body.innerHTML = response[0]['comment'];
                        }
                        else {
                            comment_body.innerHTML = "No comment recorded for this diagnostic.";
                        }
                    });

                });

                // $("#filterbox").keyup(function() {
                //     patientTable.search(this.value).draw();
                // });

                // When the user clicks on <span> (x), close the modal
                span.onclick = function() {
                    patientTable.search('').draw();
                    pcr_id.innerHTML = '';
                    comment_id.innerHTML = '';
                    comment_body.innerHTML= '';
                    modal.style.display = "none";
                }


            }


            // /////////////////////
            // Create map and layers
            // /////////////////////

            function createMap(geoJSONLayerURL) {

                ///////////
                // Map view

                const map = new Map({
                    basemap: "gray-vector"
                });

                const baseMap = new MapView({
                    container: "viewDiv",
                    map: map,
                    center: [-2.89479, 54.093409],
                    zoom: 5,
                    highlightOptions: {
                        color: [0, 62, 116, 1],
                        haloOpacity: 0.9,
                        fillOpacity: 0.2
                    },
                });


                baseMap
                    .when(function () {
                        // View successfully loaded, show viewDiv
                        document.getElementById("viewDiv").style.display = "flex";
                    })
                    .catch(function (error) {
                        if (error.name.includes("webgl")) {
                            // View was rejected, show webgl unsupported message and turn off the viewDiv
                            const divs = document.getElementsByTagName("div");
                            for (let i = 0; i < divs.length; i++) {
                                divs[i].style.display = 'none';
                            }
                            const webglDiv = document.getElementById("webglNotSupportedDiv");
                            webglDiv.innerHTML = error.message;
                            webglDiv.style.display = "flex";
                            webglDiv.style.visibility = "visible";
                        }
                    });


                /////////////
                // DATA LAYER

                // heatmap renderer
                const heatRenderer = {
                    type: "heatmap",
                    colorStops: [
                        {color: "rgba(63, 40, 102, 0)", ratio: 0},
                        {color: "#e5ff00", ratio: 0.083},
                        {color: "#fff700", ratio: 0.166},
                        {color: "#ffdd00", ratio: 0.249},
                        {color: "#ffd500", ratio: 0.332},
                        {color: "#ffc400", ratio: 0.415},
                        {color: "#ffb300", ratio: 0.498},
                        {color: "#ff9d00", ratio: 0.581},
                        {color: "#ff8400", ratio: 0.664},
                        {color: "#ff5e00", ratio: 0.747},
                        {color: "#ff3c00", ratio: 0.83},
                        {color: "#ff2200", ratio: 0.913},
                        {color: "#ff0000", ratio: 1}
                    ],
                    maxPixelIntensity: 1000,
                    minPixelIntensity: 0,
                };

                const dotRenderer = {
                    type: "unique-value",
                    field: "test_result",
                    defaultSymbol: {
                        type: "simple-marker",
                        color: "orange",
                        size: 8,
                        outline: {
                            color: "none",
                        },
                    },
                    defaultLabel: "n/a",
                    uniqueValueInfos: [{
                        value: "Positive",
                        symbol: {
                            type: "simple-marker",
                            color: "rgba(255, 0, 0, 1)",
                            size: 8,
                            outline: {
                                color: "none",
                            },
                        },
                        label: "Positive"
                    }, {
                        value: "Negative",
                        symbol: {
                            type: "simple-marker",
                            color: "rgba(0, 255, 0, 1)",
                            size: 8,
                            outline: {
                                color: "none",
                            },
                        },
                        label: "Negative",
                    },],
                    outline: {
                        color: "none",
                    },
                };


                // create data layer
                const geoJSONLayer = new GeoJSONLayer({
                    url: geoJSONLayerURL,
                    copyright: "Add copyright for COVID data if needed",
                    renderer: heatRenderer,
                    title: "COVID-19 testing",
                    // featureReduction : {
                    //     type: "cluster",
                    //     clusterRadius: 10,
                    //     popupTemplate: {
                    //         content: "This cluster represents {cluster_count} diagnostic tests."
                    //     }
                    // },
                });

                geoJSONLayer.popup = {
                    dockEnabled: true,
                    dockOptions: {
                        buttonEnabled: false,
                        breakpoint: false
                    },
                };

                // add geoJSON layer to map
                map.add(geoJSONLayer);


                /////////
                // Select which dots to display

                function updateRenderer(color, index) {
                    let renderer = geoJSONLayer.renderer.clone();
                    if (index === -1) {
                        renderer.defaultSymbol.color = color;
                    } else {
                        renderer.uniqueValueInfos[index].symbol.color = color;
                    }
                    geoJSONLayer.renderer = renderer;
                }

                const PositiveToggle = document.getElementById("positiveDots");
                const NegativeToggle = document.getElementById("negativeDots");
                const OtherToggle = document.getElementById("otherDots");
                PositiveToggle.addEventListener("change", function () {
                    if (PositiveToggle.checked) updateRenderer("rgba(255, 0, 0, 1)", 0);
                    else updateRenderer("rgba(255, 0, 0, 0)", 0);
                });
                NegativeToggle.addEventListener("change", function () {
                    if (NegativeToggle.checked) updateRenderer("rgba(0, 255, 0, 1)", 1);
                    else updateRenderer("rgba(0, 255, 0, 0)", 1);
                });
                OtherToggle.addEventListener("change", function () {
                    if (OtherToggle.checked) updateRenderer("rgba(255, 165, 0, 1)", -1);
                    else updateRenderer("rgba(255, 165, 0, 0)", -1);
                });


                //renderer selection w/ radio
                let radios = document.getElementsByName("renderer");
                let renderArray = [heatRenderer, dotRenderer];
                for (let i = 0; i < radios.length; i++) {
                    radios[i].addEventListener("change", function (event) {
                        const fieldName = event.target.value;
                        if (fieldName === "HEAT") {
                            renderArray[1] = geoJSONLayer.renderer.clone();
                            $("#dotsCheckboxSettings").hide('slow');
                            geoJSONLayer.renderer = renderArray[0];
                        }
                        if (fieldName === "DOTS") {
                            renderArray[0] = geoJSONLayer.renderer.clone();
                            $("#dotsCheckboxSettings").show('slow');
                            geoJSONLayer.renderer = renderArray[1];
                        }
                    });
                }


                ///////
                // add charts

                let centreChart;

                function createCentreChart() {
                    const centreCanvas = document.getElementById("centre-chart");
                    centreChart = new Chart(centreCanvas.getContext("2d"), {
                        type: "doughnut",
                        data: {
                            labels: ["Home", "Hospital", "GP Clinic", "Drive Through", "Other"],
                            datasets: [
                                {
                                    backgroundColor: [
                                        "#FD7F6F",
                                        "#7EB0D5",
                                        "#B2E061",
                                        "#BD7EBE",
                                        "#FFB55A"
                                    ],
                                    borderWidth: 0,
                                    data: [0, 0, 0, 0, 0]
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            cutoutPercentage: 35,
                            legend: {
                                position: "bottom"
                            },
                            title: {
                                display: true,
                                text: "Centre Type"
                            }
                        }
                    });
                }

                let genderChart;

                function createGenderChart() {
                    const genderCanvas = document.getElementById("gender-chart");
                    genderChart = new Chart(genderCanvas.getContext("2d"), {
                        type: "doughnut",
                        data: {
                            labels: ["Female", "Male", "Other", "Not provided"],
                            datasets: [
                                {
                                    backgroundColor: [
                                        "#FD7F6F",
                                        "#7EB0D5",
                                        "#B2E061",
                                        "#BD7EBE",
                                    ],
                                    borderWidth: 0,
                                    data: [0, 0, 0, 0]
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            cutoutPercentage: 35,
                            legend: {
                                position: "bottom"
                            },
                            title: {
                                display: true,
                                text: "Patient Gender"
                            }
                        }
                    });
                }

                let dateChart;

                function createDateChart() {
                    const dateCanvas = document.getElementById("date-chart");
                    dateChart = new Chart(dateCanvas.getContext("2d"), {
                        type: "line",
                        data: {
                            datasets: [{
                                label: 'Daily Tests',
                                backgroundColor: "#FD7F6F",
                                borderColor: "#B2E061",
                                fill: false,
                                data: [],
                            }, {
                                label: 'Daily positive tests',
                                backgroundColor: "#7EB0D5",
                                borderColor: "#BD7EBE",
                                fill: false,
                                data: [],
                            }]
                        },
                        options: {
                            responsive: true,

                            legend: {
                                position: "bottom",
                                labels: {
                                    "fontSize": 16,
                                }
                            },
                            title: {
                                display: true,
                                text: "Testing trends"
                            },
                            scales: {
                                xAxes: [{
                                    type: 'time',
                                    time: {
                                        unit: 'month'
                                    },
                                    ticks: {
                                        fontSize: 14
                                    },
                                }],
                                yAxes: [{
                                    ticks: {
                                        fontSize: 14
                                    },
                                    scaleLabel: {
                                        display: true,
                                        fontSize: 16,
                                        labelString: "Number of tests"
                                    }
                                }]
                            },
                            tooltips: {
                                mode: 'index',
                                intersect: false,
                            }
                        }
                    });
                }

                createCentreChart();
                createGenderChart();
                createDateChart();

                // used to update charts
                function updateChart(chart, dataValues) {
                    chart.data.datasets[0].data = dataValues;
                    chart.update();
                }

                function updateDateChart(data0, data1) {
                    dateChart.data.datasets[0].data = data0;
                    dateChart.data.datasets[1].data = data1;
                    dateChart.update();
                }

                const selection_name = document.getElementById("selection-name");
                const selection_total = document.getElementById("selection-total");
                const selection_pos = document.getElementById("selection-pos");
                const selection_neg = document.getElementById("selection-neg");

                function queryPopup(target) {
                    //set overview name
                    const country = target.graphic.attributes.NAME;
                    const region = target.graphic.attributes.nuts118nm;
                    const postcode = [target.graphic.attributes.NAME_1, target.graphic.attributes.POSTCODE_1];

                    if (country){
                        selection_name.innerHTML = country;
                        table.search(country).draw();
                    }
                    else if (region){
                        selection_name.innerHTML = region;
                        table.search(region.split('(')[0]).draw();
                    }
                    else if (postcode){
                        selection_name.innerHTML = postcode[0] + ", " + postcode[1];
                        table.search(postcode[1]).draw();
                    }
                    else{
                        console.log("Invalid search geometry")
                    }




                    const query = geoJSONLayer.createQuery();
                    query.geometry = target.graphic.geometry;
                    query.outStatistics = [

                        {
                            onStatisticField:
                                "CASE WHEN test_result = 'Positive' THEN 1 ELSE 0 END",
                            outStatisticFieldName: "positive",
                            statisticType: "sum"
                        },
                        {
                            onStatisticField:
                                "CASE WHEN test_result = 'Negative' THEN 1 ELSE 0 END",
                            outStatisticFieldName: "negative",
                            statisticType: "sum"
                        },
                        {
                            onStatisticField:
                                "CASE WHEN testing_centre__centre_type = 'Hospital' THEN 1 ELSE 0 END",
                            outStatisticFieldName: "hospital",
                            statisticType: "sum"
                        },
                        {
                            onStatisticField:
                                "CASE WHEN testing_centre__centre_type = 'Other' THEN 1 ELSE 0 END",
                            outStatisticFieldName: "other",
                            statisticType: "sum"
                        },
                        {
                            onStatisticField:
                                "CASE WHEN testing_centre__centre_type = 'GP clinic' THEN 1 ELSE 0 END",
                            outStatisticFieldName: "clinic",
                            statisticType: "sum"
                        },
                        {
                            onStatisticField:
                                "CASE WHEN testing_centre__centre_type = 'Drive through centre' THEN 1 ELSE 0 END",
                            outStatisticFieldName: "drive_through",
                            statisticType: "sum"
                        },
                        {
                            onStatisticField:
                                "CASE WHEN testing_centre__centre_type = 'Home' THEN 1 ELSE 0 END",
                            outStatisticFieldName: "home",
                            statisticType: "sum"
                        },
                        {
                            onStatisticField:
                                "CASE WHEN patient__gender = 'F' THEN 1 ELSE 0 END",
                            outStatisticFieldName: "gen_female",
                            statisticType: "sum"
                        },
                        {
                            onStatisticField:
                                "CASE WHEN patient__gender = 'M' THEN 1 ELSE 0 END",
                            outStatisticFieldName: "gen_male",
                            statisticType: "sum"
                        },
                        {
                            onStatisticField:
                                "CASE WHEN patient__gender = 'O' THEN 1 ELSE 0 END",
                            outStatisticFieldName: "gen_other",
                            statisticType: "sum"
                        },
                        {
                            onStatisticField:
                                "CASE WHEN patient__gender = 'X' THEN 1 ELSE 0 END",
                            outStatisticFieldName: "gen_na",
                            statisticType: "sum"
                        },

                    ];

                    let start = moment('2020-01-01');
                    let end = moment();
                    let i = 0;
                    let dateTotal = [];
                    let datePos = [];
                    for (let m = moment(start); m.diff(end, 'days') <= 0; m.add(1, 'day')) {
                        query.outStatistics.push(
                            {
                                onStatisticField: "CASE WHEN date_test = '" + m.format('DD-MM-YYYY') + "' THEN 1 ELSE 0 END",
                                outStatisticFieldName: i + "_tot",
                                statisticType: "sum"
                            }
                        );
                        query.outStatistics.push(
                            {
                                onStatisticField: "CASE WHEN date_test = '" + m.format('DD-MM-YYYY') + "' AND test_result = 'Positive' THEN 1 ELSE 0 END",
                                outStatisticFieldName: i + "_pos",
                                statisticType: "sum"
                            }
                        );
                        dateTotal.push(
                            {
                                x: m.format(),
                                y: 0
                            }
                        );
                        datePos.push(
                            {
                                x: m.format(),
                                y: 0
                            }
                        );
                        i += 1;
                    }


                    let popup = geoJSONLayer.queryFeatures(query).then(function (response) {
                        let data = response.features[0].attributes;
                        for (let j = 0; j < i; j++) {
                            dateTotal[j].y = data[j.toString() + "_tot"];
                            datePos[j].y = data[j.toString() + "_pos"];
                        }

                        updateChart(centreChart, [
                            data.home,
                            data.hospital,
                            data.clinic,
                            data.drive_through,
                            data.other,
                        ]);

                        updateChart(genderChart, [
                            data.gen_female,
                            data.gen_male,
                            data.gen_other,
                            data.gen_na,
                        ]);

                        updateDateChart(dateTotal, datePos);

                        return ("<table> <tbody>" +
                            "<tr> <td style=\"padding:0 15px 0 0;\">Total tests:</td> <td>" + ((data.positive + data.negative) || 0) + "</td> </tr>" +
                            "<tr> <td>Positive:</td> <td>" + (data.positive || 0) + "</td> </tr>" +
                            "<tr> <td>Negative:</td> <td>" + (data.negative || 0) + "</td> </tr>" +
                            "</tbody> </table>");
                    });

                    return popup;
                }

                //////
                // add postcode layer

                //renderer
                const lineRenderer = {
                    type: "simple",

                    symbol: {
                        type: "simple-fill",
                        style: "none",
                        outline: {
                            width: 0.1,
                            color: [0, 0, 0, 0.4],
                        },
                    },
                };

                // postcode popup
                const popupPostcode = {
                    title: "{NAME_1}, {POSTCODE_1}",
                    content: queryPopup,
                };

                // postcode layer
                let postcodes = new FeatureLayer({
                    url: "https://services.arcgis.com/dvWpUrMTxKmay5qM/arcgis/rest/services/PCSector%20with%20Regions/FeatureServer",
                    outFields: ["POSTCODE_1", "NAME_1",],
                    popupTemplate: popupPostcode,
                    renderer: lineRenderer,
                    title: "Map features",
                    minScale: 300000,
                    maxScale: 0,
                    legendEnabled: false,
                });

                // popup location
                baseMap.popup = {
                    dockEnabled: true,
                    dockOptions: {
                        buttonEnabled: true,
                        breakpoint: false
                    },
                    collapsed: true,
                };

                // add postcode layer to map
                map.add(postcodes);


                ////////
                // Add countries layer

                const countryPopup = {
                    title: "{NAME}",
                    content: queryPopup,
                };

                //renderer
                const countryRenderer = {
                    type: "simple",
                    symbol: {
                        type: "simple-fill",
                        style: "none",
                        outline: {
                            width: 0.1,
                            color: "none",
                        },
                    },
                };


                let countries = new GeoJSONLayer({
                    url: "{% static 'dashboard/data/countries.geojson' %}",
                    outFields: ["NAME"],
                    popupTemplate: countryPopup,
                    renderer: countryRenderer,
                    title: "Country",
                    minScale: 0,
                    maxScale: 8000000,
                    legendEnabled: false,
                });

                map.add(countries);


                ////////
                // Add UK regions layer

                const regionPopup = {
                    title: "{nuts118nm}",
                    content: queryPopup,
                };

                let region = new GeoJSONLayer({
                    url: "{% static 'dashboard/data/regions.geojson' %}",
                    outFields: ["nuts118nm"],
                    popupTemplate: regionPopup,
                    renderer: lineRenderer,
                    title: "Region",
                    minScale: 8000000,
                    maxScale: 300000,
                    legendEnabled: false,
                });

                map.add(region);


                ///////
                //Home button widget to reset view
                const homeWidget = new Home({
                    view: baseMap
                });


                ///////
                // Search widget
                const search = new Search({
                    view: baseMap,
                    locationEnabled: false,
                });


                ///////
                // fullscreen widget
                const fullscreen = new Fullscreen({
                    view: baseMap
                });


                ///////
                // basemap gallery
                const gallery = new BasemapGallery({
                    view: baseMap,
                });


                ///////
                // postcode map toggle
                const PostcodeToggle = document.getElementById("postcodeLayer");
                PostcodeToggle.addEventListener("change", function () {
                    postcodes.visible = PostcodeToggle.checked;
                });


                /////////
                // time slider
                // const timeSlider = new TimeSlider({
                //     container: "timeSlider",
                //     mode: "cumulative-from-start",
                //     view: baseMap
                // });
                //
                // baseMap.ui.add(timeSlider, "manual");
                //
                // baseMap.whenLayerView(geoJSONLayer).then(function(lv) {
                //     const fullTimeExtent = geoJSONLayer.timeInfo.fullTimeExtent;
                //
                //     // set up time slider properties
                //     timeSlider.fullTimeExtent = fullTimeExtent;
                //     timeSlider.playRate = 200;
                //
                //     timeSlider.stops = {
                //         interval: geoJSONLayer.timeInfo.interval,
                //     };
                // });


                ///////
                // add views and widgets
                baseMap.ui.add("selectionPaneDiv", "bottom-left");
                baseMap.ui.add(fullscreen, "bottom-right");
                baseMap.ui.add(homeWidget, "top-left");
                baseMap.ui.add(search, "top-right");
                baseMap.ui.add(
                    [
                        new Expand({
                            view: baseMap,
                            content: gallery,
                            group: "top-left",
                            expanded: false
                        }),
                    ],
                    "top-left"
                );
                baseMap.ui.add(
                    [
                        new Expand({
                            view: baseMap,
                            content: new Legend({view: baseMap}),
                            group: "top-left",
                            expanded: !(isMobileDevice()),
                        }),
                    ],
                    "top-left"
                );
                baseMap.ui.add(
                    [
                        new Expand({
                            view: baseMap,
                            content: document.getElementById("selectionPaneDiv"),
                            group: "bottom-left",
                            expanded: !(isMobileDevice()),
                        }),
                    ],
                    "bottom-left"
                );
            }
        });


    </script>



</head>
<body>

<div class="grid-container">
    <div class="header-container">

        <img src="{% static 'dashboard/images/logo.svg' %}" style='max-height: 100%; width: auto; object-fit: contain'/>

        <h2>
            Centre for Bio-Inspired Technology
        </h2>

        <div class="dropdown">
            <button onclick="openDropdown()" class="dropButton">Menu</button>
            <div id="dropdown" class="dropdown-content">
                <a href="{{ URL_SCHEME }}://{{ HOSTNAME }}/dataUpload/" target="_blank">Upload Data</a>
                <a href="https://protondx.com/" target="_blank">About</a>
                <a href="https://protondx.com/contact/" target="_blank">Contact</a>
                <a href="{{ URL_SCHEME }}://{{ HOSTNAME }}/admin/" target="_blank">Admin</a>
                <a href="{% url "logout" %}?next=/dashboard">Logout</a>
            </div>
        </div>

    </div>
    <div class="body-container">
        <div id="viewDiv" class="mapView"></div>
        <div class="side-view">
            <div class="graph-container">
                <div class="side-header">
                    <h2 style="display: inline">Overview: </h2><h2 style="display: inline" id="selection-name"></h2>
                </div>
                <div class="pie-container">
                    <div id="centre-chart-div" class="left-pie">
                        <canvas id="centre-chart" width="0" height="0"></canvas>
                    </div>
                    <div id="gender-chart-div" class="right-pie">
                        <canvas id="gender-chart" width="0" height="0"></canvas>
                    </div>
                </div>
                <div id="date-chart-div" class="line-graph-container">
                    <canvas id="date-chart" width="0" height="0"></canvas>
                </div>
            </div>
            <div class="table-container">
                <table id="side-table" class="display compact" cellspacing="0" width="100%" style="overflow-x: auto">
                    <thead>
                    <tr>
                        <th>Patient ID</th>
                        <th>Test Date</th>
                        <th>Result</th>
                        <th>Centre Type</th>
                        <th>Postcode</th>
                        <th>County</th>
                        <th>Region</th>
                        <th>Country</th>
                    </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>
</div>



<!--<div id="viewDiv"></div>-->
<!--<div id="timeSlider"></div>-->
<div id="selectionPaneDiv" class="esri-widget">
    <p>Visualise COVID-19 spread using:</p>
    <label>
        <input type="radio" name="renderer" value="HEAT" checked />
        Heatmap
    </label> <br />

    <label>
        <input type="radio" name="renderer" value="DOTS" />
        Dots
    </label> <br />

    <div id="dotsCheckboxSettings" style="display: none">
        <label>
            <input type="checkbox" id="positiveDots" checked>Show positive test results
        </label>
        <br>
        <label>
            <input type="checkbox" id="negativeDots" checked>Show negative tests results
        </label>
        <br>
        <label>
            <input type="checkbox" id="otherDots" checked>Show inconclusive tests
        </label>
    </div>

    <br />

    <label>
        <input type="checkbox" id="postcodeLayer" checked> Postcode Boundaries
    </label>
</div>


<!-- The Modal -->
<div id="myModal" class="modal">

    <!-- Modal content -->
    <div id="modal-content" class="modal-content">
        <div class="md-grid-container">
            <div class="md-modal-heading">
                <h2>
                    <span class="right close vertical-middle">&times;</span><span class="left vertical-middle" id="modal-patient-name"></span>
                </h2>
            </div>
            <div class="md-modal-body">
                <div class="md-modal-diagnostic">
                    <div class="md-modal-pcr">
                        <h3 style="display: inline">PCR Graph - Test ID: #</h3><h3 style="display: inline" id="pcr-id"></h3>
                        <hr>

                        <canvas id="pcr-chart" width="0" height="0"></canvas>

                    </div>
                    <div class="md-modal-comments">
                        <h3 style="display: inline">Diagnostic comments - Test ID: #</h3><h3 style="display: inline" id="comment-id"></h3>
                        <hr>
                        <p id="comment-body"></p>
                    </div>
                </div>
                <div class="md-modal-patient">
                    <h3 style="display: inline">Patient Information</h3>
                    <hr>
                    <table id="patient-information-table">
                        <tbody>
                        <tr> <td style="padding:0 15px 0 0;">Patient ID:</td> <td id="tr-patient-id"></td> </tr>
                        <tr> <td>Gender:</td> <td id="tr-patient-gender"></td> </tr>
                        <tr> <td>Date of Birth (Age):</td> <td id="tr-patient-dob"></td> </tr>
                        <tr> <td>Postcode:</td> <td id="tr-patient-postcode"></td> </tr>
                        <tr> <td>Diagnostic tests:</td> <td id="tr-patient-count"></td> </tr>
                        </tbody>
                    </table>
                    <br/>
                    <br/>
                    <div id="patient-table-div">
                        <h3 style="display: inline">Testing History</h3>
                        <!--                        <input type="text" id="filterbox">-->
                        <hr>
                        <table id="patient-table" class="display nowrap" cellspacing="0" width="100%">
                            <thead>
                            <tr>
                                <th>Test Date</th>
                                <th>Result</th>
                                <th>Centre Type</th>
                            </tr>
                            </thead>
                        </table>
                    </div>

                </div>
            </div>
        </div>
    </div>

</div>



<!--dropdown menu script + modal exit-->
<script src="{% static 'dashboard/js/dropDown.js' %}"></script>


</body>
</html>