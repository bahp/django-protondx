<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">

    <title>COVID-19 Dashboard</title>


    <!--DATATABLES-->
    <script src="https://code.jquery.com/jquery-1.12.3.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.21/css/jquery.dataTables.css">
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.js"></script>
    <script src="https://cdn.datatables.net/plug-ins/1.10.21/features/pageResize/dataTables.pageResize.min.js"></script>

    <!--CSS templates-->
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'dashboard/layout.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'dashboard/datatables.css' %}">

    <!--ARCGIS-->
    <link rel="stylesheet" href="https://js.arcgis.com/4.15/esri/themes/dark/main.css">
    <script src="https://js.arcgis.com/4.15/"></script>


    <script>
        function isMobileDevice() {
            return (typeof window.orientation !== "undefined") || (navigator.userAgent.indexOf('IEMobile') !== -1);
        }



        let table;
        require([
            "esri/Map",
            "esri/views/MapView",
            "esri/geometry/Extent",
            "esri/layers/FeatureLayer",
            "esri/layers/GeoJSONLayer",
            "esri/renderers/DotDensityRenderer",
            "esri/renderers/SimpleRenderer",
            "esri/Graphic",
            "esri/geometry/support/webMercatorUtils",
            "esri/widgets/Home",
            "esri/widgets/Legend",
            "esri/widgets/Expand",
            "esri/widgets/Fullscreen",
            "esri/widgets/Search",
            "esri/widgets/BasemapGallery",
        ], function(Map,
                    MapView,
                    Extent,
                    FeatureLayer,
                    GeoJSONLayer,
                    DotDensityRenderer,
                    SimpleRenderer,
                    Graphic,
                    webMercatorUtils,
                    Home,
                    Legend,
                    Expand,
                    Fullscreen,
                    Search,
                    BasemapGallery,) {


            const HOST_NAME = "http://10.1.1.170:8000"
            // const HOST_NAME = "http://localhost:8000"


            // //////////
            // DATA fetch
            // //////////

            const urlGeoJSON = HOST_NAME + "/dashboard/api/get-points/"
            const QuerySettings = {
                url: urlGeoJSON,
                method: "GET",
                success: function (data) {
                    populateDataTable(JSON.parse(data));

                    const blob = new Blob([(data)], {type: "application/json"});
                    const urlLayer  = URL.createObjectURL(blob);
                    createMap(urlLayer);
                },
                error: function (e) {
                    console.log("There was an error with your request...");
                    console.log("error: " + JSON.stringify(e));
                }
            };

            $.ajax(QuerySettings);


            // /////////////////
            // Create data table
            // /////////////////

            function populateDataTable(data) {

                table = $('#side-table').DataTable( {
                    data: data.features,
                    columns: [
                        {
                            data: "properties.date_test",
                            render: function ( data, type, row ) {
                                const dateSplit = data.split('T')[0].split('-');
                                return type === "display" || type === "filter" ?
                                    dateSplit[2] +'-'+ dateSplit[1] +'-'+ dateSplit[0] :
                                    data;
                            }
                        },
                        {
                            data: "properties.test_result",
                            // render: function (data, type, row){
                            //     switch(data) {
                            //         case "True":
                            //             return "Positive";
                            //         case "False":
                            //             return "Negative";
                            //         default:
                            //             return "n/a";
                            //     }
                            // }
                        },
                        {
                            data: "properties.testing_centre__centre_type",
                            // render: function (data, type, row){
                            //     switch(data) {
                            //         case "HOSP":
                            //             return "Hospital";
                            //         case "CLIN":
                            //             return "GP Clinic";
                            //         case "DRIV":
                            //             return "Drive through";
                            //         case "HOME":
                            //             return "Home test";
                            //         case "OTHR":
                            //             return "Other";
                            //         default:
                            //             return "n/a";
                            //     }
                            // }
                        },
                        { data: "properties.testing_centre__postcode" },

                    ],
                    pageResize: true,
                    rowId: 'properties.pk',
                });



            };


            // /////////////////////
            // Create map and layers
            // /////////////////////

            function createMap(geoJSONLayerURL) {
                ///////////
                // Map view

                const map = new Map({
                    basemap: "dark-gray-vector"
                });

                const baseMap = new MapView({
                    container: "viewDiv",
                    map: map,
                    center: [-2.89479, 54.093409],
                    zoom: 5
                });


                baseMap
                    .when(function() {
                        // View successfully loaded, show viewDiv
                        document.getElementById("viewDiv").style.display = "flex";
                    })
                    .catch(function(error) {
                        if (error.name.includes("webgl")) {
                            // View was rejected, show webgl unsupported message and turn off the viewDiv
                            const divs = document.getElementsByTagName("div");
                            for (let i = 0; i < divs.length; i++) {
                                divs[i].style.display = 'none';
                            }
                            const webglDiv = document.getElementById("webglNotSupportedDiv");
                            webglDiv.innerHTML = error.message;
                            webglDiv.style.display = "flex";
                            webglDiv.style.visibility = "visible";
                        }
                    });


                /////////////
                // DATA LAYER

                // heatmap renderer
                const heatRenderer = {
                    type: "heatmap",
                    colorStops: [
                        {color: "rgba(63, 40, 102, 0)", ratio: 0},
                        {color: "#e5ff00", ratio: 0.083},
                        {color: "#fff700", ratio: 0.166},
                        {color: "#ffdd00", ratio: 0.249},
                        {color: "#ffd500", ratio: 0.332},
                        {color: "#ffc400", ratio: 0.415},
                        {color: "#ffb300", ratio: 0.498},
                        {color: "#ff9d00", ratio: 0.581},
                        {color: "#ff8400", ratio: 0.664},
                        {color: "#ff5e00", ratio: 0.747},
                        {color: "#ff3c00", ratio: 0.83},
                        {color: "#ff2200", ratio: 0.913},
                        {color: "#ff0000", ratio: 1}
                    ],
                    maxPixelIntensity: 25,
                    minPixelIntensity: 0,
                };

                var dotRenderer = {
                    type: "unique-value",
                    field: "test_result",
                    defaultSymbol: {
                        type: "simple-marker",
                        color: "orange",
                        size: 8,
                        outline:{
                            style: "none",
                        },
                    },
                    defaultLabel: "n/a",
                    uniqueValueInfos: [{
                        value: "Positive",
                        symbol: {
                            type: "simple-marker",
                            color: "rgba(255, 0, 0, 1)",
                            size: 8,
                            outline:{
                                style: "none",
                            },
                        },
                        label: "Positive"
                    }, {
                        value: "Negative",
                        symbol: {
                            type: "simple-marker",
                            color: "rgba(0, 255, 0, 1)",
                            size: 8,
                            outline: {
                                style: "none",
                            },
                        },
                        label: "Negative",
                    },],
                    outline:{
                        style: "none",
                    },
                };

                // POPUP FOR DATA LAYER
                const template = {
                    title: "Test Information:",
                    content: "Test result: {test_result} <br> Test date: {date_test} <br> Centre type: {testing_centre__centre_type} <br> Postcode: {testing_centre__postcode}",
                };

                // create data layer
                const geoJSONLayer = new GeoJSONLayer({
                    url: geoJSONLayerURL,
                    copyright: "Add copyright for COVID data if needed",
                    renderer: heatRenderer,
                    title: "COVID-19 testing",
                    popupTemplate: template,
                    // featureReduction : {
                    //     type: "cluster",
                    //     clusterRadius: 10,
                    //     popupTemplate: {
                    //         content: "This cluster represents {cluster_count} diagnostic tests."
                    //     }
                    // },
                });

                geoJSONLayer.popup = {
                    dockEnabled: true,
                    dockOptions: {
                        buttonEnabled: false,
                        breakpoint: false
                    },
                };

                /////////
                // Select which dots to display
                function updateRenderer(color, index) {
                    let renderer = geoJSONLayer.renderer.clone();
                    if (index === -1) {
                        renderer.defaultSymbol.color = color;
                    }
                    else{
                        renderer.uniqueValueInfos[index].symbol.color = color;
                    }
                    geoJSONLayer.renderer = renderer;
                }

                const PositiveToggle = document.getElementById("positiveDots");
                const NegativeToggle = document.getElementById("negativeDots");
                const OtherToggle = document.getElementById("otherDots");
                PositiveToggle.addEventListener("change", function () {
                    if (PositiveToggle.checked) updateRenderer("rgba(255, 0, 0, 1)", 0);
                    else updateRenderer("rgba(255, 0, 0, 0)", 0);
                });
                NegativeToggle.addEventListener("change", function () {
                    if (NegativeToggle.checked) updateRenderer("rgba(0, 255, 0, 1)", 1);
                    else updateRenderer("rgba(0, 255, 0, 0)", 1);
                });
                OtherToggle.addEventListener("change", function () {
                    if (OtherToggle.checked) updateRenderer("rgba(255, 165, 0, 1)", -1);
                    else updateRenderer("rgba(255, 165, 0, 0)", -1);
                });

                //renderer selection w/ radio
                let radios = document.getElementsByName("renderer");
                let renderArray = [heatRenderer, dotRenderer];
                for (let i = 0; i < radios.length; i++) {
                    radios[i].addEventListener("change", function (event) {
                        const fieldName = event.target.value;
                        if (fieldName === "HEAT") {
                            renderArray[1] = geoJSONLayer.renderer.clone();
                            $("#dotsCheckboxSettings").hide('slow');
                            geoJSONLayer.renderer = renderArray[0];
                        }
                        if (fieldName === "DOTS") {
                            renderArray[0] = geoJSONLayer.renderer.clone();
                            $("#dotsCheckboxSettings").show('slow');
                            geoJSONLayer.renderer = renderArray[1];
                        }
                    });
                }

                // ////////////
                // Postcode Map

                //renderer
                const lineRenderer = {
                    type: "simple",

                    symbol: {
                        type: "simple-fill",
                        style: "none",
                        outline: {
                            width: 0.1,
                            color: [0, 0, 0, 0.4],
                        },
                    },
                    label: "Postcode Sector Boundaries"
                };

                // postcode map and popup
                function queryPopup(target) {

                    const url = HOST_NAME + "/dashboard/api/get-postcode-data/?postcode="
                        + encodeURIComponent((target.graphic.attributes.POSTCODE_1).trim())

                    // Should try and not use async: false
                    let tmp;
                    const QuerySettings = {
                        url: url,
                        method: "GET",
                        async: false,
                        success: function (data) {
                            tmp = ("<table> <tbody>" +
                                "<tr> <td style=\"padding:0 15px 0 0;\">Total tests:</td> <td>" + (data.summary.total) + "</td> </tr>" +
                                "<tr> <td>Positive:</td> <td>" + (data.summary.positive) + "</td> </tr>" +
                                "<tr> <td>Negative:</td> <td>" + (data.summary.negative) + "</td> </tr>" +
                                "<tr> <td>Patients:</td> <td>" + (data.summary.patients) + "</td> </tr>" +
                                "</tbody> </table>");
                        },
                        error: function (e) {
                            console.log("There was an error with your request...");
                            console.log("error: " + JSON.stringify(e));
                        }
                    };

                    $.ajax(QuerySettings);

                    return tmp;

                }

                // postcode popup
                const popupPostcode = {
                    title: "{NAME_1}, {POSTCODE_1}",
                    content: queryPopup,
                };

                // postcode layer
                let postcodes = new FeatureLayer({
                    url: "https://services.arcgis.com/dvWpUrMTxKmay5qM/arcgis/rest/services/PCSector%20with%20Regions/FeatureServer",
                    outFields: ["POSTCODE_1", "NAME_1",],
                    popupTemplate: popupPostcode,
                    renderer: lineRenderer,
                    title: "Map features",
                    minScale: 3000000,
                    maxScale: 0,
                });

                //postcode popup
                baseMap.popup = {
                    dockEnabled: true,
                    dockOptions: {
                        buttonEnabled: false,
                        breakpoint: false
                    },
                };

                // add postcode layer to map
                map.add(postcodes);


                ///////
                //Home button widget to reset view
                const homeWidget = new Home({
                    view: baseMap
                });


                ///////
                // Search widget
                const search = new Search({
                    view: baseMap,
                    locationEnabled: false,
                });


                // Display postcode popup on search
                search.on("select-result", function(event){
                    // get coordinates of searched address
                    const coordinates = webMercatorUtils.xyToLngLat(event.result.feature.geometry.x, event.result.feature.geometry.y);

                    // make apoint out of them
                    let point = {
                        type: "point",
                        x: coordinates[0],
                        y: coordinates[1]
                    };


                    // query the postcode layer to see which poscodes intersect with the point
                    let query = postcodes.createQuery();
                    query.geometry = point;
                    query.spatialRelationship = "intersects";
                    postcodes.queryFeatures(query)
                        .then(function(feature) {

                            // filter by postcode in datatables
                            // comment out if feature not needed
                            table.search(feature.features[0].attributes.POSTCODE_1).draw();

                            // open popup of query result
                            baseMap.popup.open({
                                features: feature.features
                            });
                        });
                });


                ///////
                // fullscreen widget
                const fullscreen = new Fullscreen({
                    view: baseMap
                });


                ///////
                // basemap gallery
                const gallery = new BasemapGallery({
                    view: baseMap,
                });


                ///////
                // postcode map toggle
                const PostcodeToggle = document.getElementById("postcodeLayer");
                PostcodeToggle.addEventListener("change", function () {
                    postcodes.visible = PostcodeToggle.checked;
                });


                // add geoJSON layer to map
                map.add(geoJSONLayer);


                //////////////
                // Highlight map on table select

                let highlightSelect;
                baseMap.whenLayerView(geoJSONLayer).then(function(layerView) {
                    let queryLayer = geoJSONLayer.createQuery();

                    $('#side-table tbody').on( 'click', 'tr', function () {

                        // remove selection if clicking on a selected row
                        if ( table.row(this).node().className.includes('selected')){
                            $(this).removeClass('selected');
                            if (highlightSelect) {
                                highlightSelect.remove();
                            }
                        }
                        // remove old selection and add selection on new row
                        else{
                            $(this).addClass('selected').siblings().removeClass('selected');
                            const id = table.row( this ).id();

                            queryLayer.where = "pk='" + id + "'";
                            geoJSONLayer.queryFeatures(queryLayer).then(function(result) {
                                // if a feature is already highlighted, then remove the highlight
                                if (highlightSelect) {
                                    highlightSelect.remove();
                                }

                                // the feature to be highlighted
                                const feature = result.features[0];

                                // use the objectID to highlight the feature
                                highlightSelect = layerView.highlight(
                                    feature.attributes["OBJECTID"]
                                );
                                // baseMap.popup.selectedFeatureIndex = feature.attributes["OBJECTID"];
                                // baseMap.popup.open(template);


                                // center the feature
                                baseMap
                                    .goTo(
                                        {
                                            target: feature.geometry,
                                            zoom: 15
                                        },
                                        {
                                            duration: 1000,
                                            easing: "in-out-expo"
                                        }
                                    )
                                    .catch(function(error) {
                                        if (error.name != "AbortError") {
                                            console.log(error);
                                        }
                                    });
                            });
                        }
                    });
                });


                ///////
                // add views and widgets
                baseMap.ui.add("selectionPaneDiv", "bottom-left");
                baseMap.ui.add(fullscreen, "bottom-right");
                baseMap.ui.add(homeWidget, "top-left");
                baseMap.ui.add(search, "top-right");
                baseMap.ui.add(
                    [
                        new Expand({
                            view: baseMap,
                            content: gallery,
                            group: "top-left",
                            expanded: false
                        }),
                    ],
                    "top-left"
                );
                baseMap.ui.add(
                    [
                        new Expand({
                            view: baseMap,
                            content: new Legend({view: baseMap}),
                            group: "top-left",
                            expanded: !(isMobileDevice()),
                        }),
                    ],
                    "top-left"
                );
                baseMap.ui.add(
                    [
                        new Expand({
                            view: baseMap,
                            content: document.getElementById("selectionPaneDiv"),
                            group: "bottom-left",
                            expanded: !(isMobileDevice()),
                        }),
                    ],
                    "bottom-left"
                );

            };
        });


    </script>
</head>
<body>

<div id="viewDiv"></div>
<div id="selectionPaneDiv" class="esri-widget">
    <p>Visualise COVID-19 spread using:</p>
    <label>
        <input type="radio" name="renderer" value="HEAT" checked />
        Heatmap
    </label> <br />

    <label>
        <input type="radio" name="renderer" value="DOTS" />
        Dots
    </label> <br />

    <div id="dotsCheckboxSettings" style="display: none">
        <label>
            <input type="checkbox" id="positiveDots" checked>Show positive test results
        </label>
        <br>
        <label>
            <input type="checkbox" id="negativeDots" checked>Show negative tests results
        </label>
        <br>
        <label>
            <input type="checkbox" id="otherDots" checked>Show inconclusive tests
        </label>
    </div>

    <br />

    <label>
        <input type="checkbox" id="postcodeLayer" checked> Postcode Boundaries
    </label>



</div>

<div id="feature-node-right-top" class="esri-widget">
    <!--    <button class="esri-button" id="zoom">Zoom to selected feature</button>-->
    <table id="side-table" class="display" cellspacing="0" width="100%">
        <thead>
        <tr>
            <th>Test Date</th>
            <th>Result</th>
            <th>Centre Type</th>
            <th>Postcode</th>
        </tr>
        </thead>
    </table>
</div>

<div id="feature-node-right-bottom" class="esri-widget">
    <table>
        <tbody>
        <tr>
            <td>Total tests (UK):</td>
            <td>{{ count_total_exp }}</td>
        </tr>
        <tr>
            <td>Total positive (UK):</td>
            <td>{{ count_pos_exp }}</td>
        </tr>
        <tr>
            <td>Total negative (UK):</td>
            <td>{{ count_neg_exp }}</td>
        </tr>
        <tr>
            <td>Total patients tested (UK):</td>
            <td>{{ count_indiv_patients }}</td>
        </tr>
        </tbody>
    </table>
</div>


<div id="webglNotSupportedDiv"></div>


</body>
</html>