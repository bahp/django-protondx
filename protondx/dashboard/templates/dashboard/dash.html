<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">

    <title>COVID-19 Dashboard</title>


    <!--DATATABLES-->
    <script src="https://code.jquery.com/jquery-1.12.3.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.21/css/jquery.dataTables.css">
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.js"></script>

    <script src="https://cdn.datatables.net/plug-ins/1.10.21/features/pageResize/dataTables.pageResize.min.js"></script>
    <!--CSS template-->
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'dashboard/layout.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'dashboard/datatables.css' %}">

    <!--ARCGIS-->
    <link rel="stylesheet" href="https://js.arcgis.com/4.15/esri/themes/dark/main.css">
    <script src="https://js.arcgis.com/4.15/"></script>


    <script>
        require([
            "esri/Map",
            "esri/views/MapView",
            "esri/geometry/Extent",
            "esri/layers/FeatureLayer",
            "esri/layers/GeoJSONLayer",
            "esri/renderers/DotDensityRenderer",
            "esri/renderers/SimpleRenderer",
            "esri/Graphic",
            "esri/widgets/Feature",
            "esri/popup/content/BarChartMediaInfo",
            "esri/popup/content/support/ChartMediaInfoValue",
            "esri/popup/content/MediaContent",
            "esri/widgets/Home",
            "esri/widgets/Legend",
            "esri/widgets/Expand",
            "esri/widgets/Fullscreen",
            "esri/widgets/Search",
            "esri/widgets/BasemapGallery",
            "esri/widgets/FeatureTable",
        ], function(Map,
                    MapView,
                    Extent,
                    FeatureLayer,
                    GeoJSONLayer,
                    DotDensityRenderer,
                    SimpleRenderer,
                    Graphic,
                    Feature,
                    BarChartMediaInfo,
                    ChartMediaInfoValue,
                    MediaContent,
                    Home,
                    Legend,
                    Expand,
                    Fullscreen,
                    Search,
                    BasemapGallery,
                    FeatureTable,) {

            // Map view
            const map = new Map({
                basemap: "dark-gray-vector"
            });

            const baseMap = new MapView({
                container: "viewDiv",
                map: map,
                center: [-2.89479, 54.093409],
                zoom: 5
            });

            // DATA LAYER

            // heatmap renderer
            const heatRenderer = {
                type: "heatmap",
                colorStops: [
                    { color: "rgba(63, 40, 102, 0)", ratio: 0 },
                    { color: "#e5ff00", ratio: 0.083 },
                    { color: "#fff700", ratio: 0.166 },
                    { color: "#ffdd00", ratio: 0.249 },
                    { color: "#ffd500", ratio: 0.332 },
                    { color: "#ffc400", ratio: 0.415 },
                    { color: "#ffb300", ratio: 0.498 },
                    { color: "#ff9d00", ratio: 0.581 },
                    { color: "#ff8400", ratio: 0.664 },
                    { color: "#ff5e00", ratio: 0.747 },
                    { color: "#ff3c00", ratio: 0.83 },
                    { color: "#ff2200", ratio: 0.913 },
                    { color: "#ff0000", ratio: 1 }
                ],
                maxPixelIntensity: 25,
                minPixelIntensity: 0,
            };

            // dot renderer
            const dotRenderer = {
                type: "simple",
                symbol: {
                    type: "simple-marker",
                    size: 6,
                    color: "red",
                },
                label: "Individual case",
            };

            // POPUP FOR DATA LAYER
            const template = {
                title: "Centre Info",
                content: "Centre type: {centre_type} <br> <br> Postcode: {postcode}",
                // fieldInfos: [
                //     {
                //         fieldName: "time",
                //         format: {
                //             dateFormat: "short-date-short-time"
                //         }
                //     }
                // ]
            };

            // DATA fetch
            const urlGeoJSON = "http://localhost:8000/dashboard/api/get-points/"
            //
            // let QuerySettings = {
            //     url: urlGeoJSON,
            //     async: false,
            //     method: "GET",
            //     timeout: 0,
            //     dataType: "json",
            // };
            //
            // let responseData;
            // $.ajax(QuerySettings).done(function (response) {
            //     responseData = response;
            // });

            // Create data table in right div
            $(document).ready(function() {
                //console.log(responseData);
                $('#side-table').DataTable( {
                    // "data":responseData.features,
                    ajax: {
                        url: urlGeoJSON,
                        dataSrc: "features",
                    },
                    "columns": [
                        { data: "properties.centre_type" },
                        { data: "properties.postcode" },
                    ],
                    pageResize: true,
                });
            });

            // create data layer
            const geoJSONLayer = new GeoJSONLayer({
                url: urlGeoJSON,
                copyright: "Add copyright for COVID data if needed",
                renderer: heatRenderer,
                title: "COVID-19 spread",
                popupTemplate: template,
                // featureReduction : {
                //     type: "cluster",
                //     clusterRadius: 10
                // },
            });


            //renderer selection w/ radio
            let radios = document.getElementsByName("renderer");
            for (let i = 0; i < radios.length; i++) {
                radios[i].addEventListener("change", function(event) {
                    const fieldName = event.target.value;
                    if (fieldName === "HEAT") {
                        geoJSONLayer.renderer = heatRenderer;
                    }
                    if (fieldName === "DOTS") {
                        geoJSONLayer.renderer = dotRenderer;
                    }
                });
            }

            // graph test
            // let barChartValue = new ChartMediaInfoValue({
            //     fields: ["centre_type"],
            //     normalizeField: null,
            //     tooltipField: "Centre Type"
            // });
            //
            //
            // let barChart = new BarChartMediaInfo({
            //     title: "<b>Count by type</b>",
            //     caption: "Per block",
            //     value: barChartValue
            // });
            //
            //
            // let mediaElement = new MediaContent({
            //     mediaInfos: [barChart]
            // });
            //
            //
            // let feature = new Feature({
            //     graphic: mediaElement,
            //     container: "feature-node-right-top",
            //     view: geoJSONLayer
            //
            // });


            // //////
            // renderers for postcode map
            // //////

            const lineRenderer = {
                type: "simple",

                symbol: {
                    type: "simple-fill",
                    style: "none",
                    outline:{
                        width: 0.1,
                        color: [0, 0, 0, 0.4],
                    },
                },
                label: "Postcode Sector Boundaries"
            };

            // postcode map and popup
            function queryPopup(target) {

                const url = "http://localhost:8000/dashboard/api/get-postcode-data/?postcode="
                    + encodeURIComponent((target.graphic.attributes.POSTCODE_1).trim())

                //////
                // WORKING BUT...
                // DO NOT USE ASYNC: FALSE
                // CHANGE TO PROPER AJAX GOOD PRACTICE
                //////
                let popupQuerySettings = {
                    "url": url,
                    "async": false,
                    "method": "GET",
                    "timeout": 0,
                };

                let postcodeData;
                $.ajax(popupQuerySettings).done(function (response) {
                    console.log(response)
                    postcodeData = response.summary;
                });


                ///////
                // Change postcodeData.count to postcodeData.total
                // and  " + 0 + " to postcodeData.positive, ...
                // once the backend has been implemented
                ///////

                return (
                    "<table> <tbody>" +
                    "<tr> <td style=\"padding:0 15px 0 0;\">Total tests:</td> <td>"+ (postcodeData.total) + "</td> </tr>" +
                    "<tr> <td>Positive:</td> <td>" + (postcodeData.positive) + "</td> </tr>" +
                    "<tr> <td>Negative:</td> <td>" + (postcodeData.negative) + "</td> </tr>" +
                    "<tr> <td>Patients:</td> <td>" + (postcodeData.patients) + "</td> </tr>" +
                    "</tbody> </table>"
                );
            }

            const popupPostcode = {
                title: "{NAME_1}, {POSTCODE_1}",
                content: queryPopup,
            };

            // postcode layer
            let postcodes = new FeatureLayer({
                url: "https://services.arcgis.com/dvWpUrMTxKmay5qM/arcgis/rest/services/PCSector%20with%20Regions/FeatureServer",
                outFields: ["POSTCODE_1", "NAME_1",], // "OBJECTID"],
                popupTemplate: popupPostcode,
                renderer: lineRenderer,
                title: "Map features",
                minScale: 3000000,
                maxScale:0,
            });

            //postcode popup
            baseMap.popup = {
                dockEnabled: true,
                dockOptions: {
                    buttonEnabled: false,
                    breakpoint: false
                },
            };

            // add postcode layer to map
            map.add(postcodes);


            //Home button widget to reset view
            const homeWidget = new Home({
                view: baseMap
            });


            // Search widget
            const search = new Search({
                view: baseMap,
                locationEnabled: true,
            });


            // fullscreen widget
            const fullscreen = new Fullscreen({
                view: baseMap
            });


            // basemap gallery
            const gallery = new BasemapGallery({
                view: baseMap,
            });


            // postcode map toggle
            const PostcodeToggle = document.getElementById("postcodeLayer");
            PostcodeToggle.addEventListener("change", function() {
                postcodes.visible = PostcodeToggle.checked;
            });



            // add geoJSON layer to map
            map.add(geoJSONLayer);


            // // side table
            // const featureTable = new FeatureTable({
            //     layer: geoJSONLayer,
            //     container: "feature-node-right-top",
            //     visibleElements: {
            //         header: true,
            //         menu: true,
            //         menuItems: {
            //             clearSelection: true,
            //             refreshData: false,
            //             toggleColumns: true,
            //         },
            //     },
            // });
            //
            // const highlights = [];
            // baseMap.whenLayerView(geoJSONLayer).then(function(layerView) {
            //     featureTable.on("selection-change", function (changes) {
            //         // If the selection is removed remove its highlighted feature from the layerView
            //         changes.removed.forEach(function (item) {
            //             const data = highlights.find(function (data) {
            //                 return data.feature === item.feature;
            //             });
            //             if (data) {
            //                 highlights.splice(highlights.indexOf(data), 1);
            //                 data.highlight.remove();
            //             }
            //         });
            //
            //         // If the selection is added, push all added selections to array and highlight on layerView
            //         changes.added.forEach(function (item) {
            //             const feature = item.feature;
            //             let highlight = layerView.highlight(item.feature);
            //             highlights.push({
            //                 feature: feature,
            //                 highlight: highlight
            //             });
            //         });
            //     });
            //
            //     const zoomBtn = document.getElementById("zoom");
            //     zoomBtn.addEventListener("click", zoomToSelectedFeature);
            //
            //     // fires when "Zoom to selected feature" button is clicked
            //     function zoomToSelectedFeature() {
            //         // Create a query off of the feature layer
            //         const query = geoJSONLayer.createQuery();
            //         // Iterate through the highlights and grab the feature's objectID
            //         const featureIds = highlights.map(function(result) {
            //             return result.feature.getAttribute(geoJSONLayer.objectIdField);
            //         });
            //         // Set the query's objectId
            //         query.objectIds = featureIds;
            //         // Make sure to return the geometry to zoom to
            //         query.returnGeometry = true;
            //         // Call queryFeatures on the feature layer and zoom to the resulting features
            //         geoJSONLayer.queryFeatures(query).then(function(results) {
            //             results.features.zoom = 12;
            //             baseMap.goTo(results.features).catch(function(error) {
            //                 if (error.name != "AbortError") {
            //                     console.error(error);
            //                 }
            //             });
            //         });
            //     }
            // });


            // add views and widgets
            baseMap.ui.add(fullscreen, "bottom-right");
            baseMap.ui.add(homeWidget, "top-left");
            baseMap.ui.add(search, "top-right");
            baseMap.ui.add(
                [
                    new Expand({
                        view: baseMap,
                        content: gallery,
                        group: "top-left",
                        expanded: false
                    }),
                ],
                "top-left"
            );
            baseMap.ui.add(
                [
                    new Expand({
                        view: baseMap,
                        content: new Legend({ view: baseMap }),
                        group: "top-left",
                        expanded: true
                    }),
                ],
                "top-left"
            );
        });


    </script>
</head>
<body>

<div id="viewDiv"></div>

<div id="feature-node-right-top" class="esri-widget">
    <!--    <button class="esri-button" id="zoom">Zoom to selected feature</button>-->
    <table id="side-table" class="display" cellspacing="0" width="100%">
        <thead>
        <tr>
            <th>Centre Type</th>
            <th>Postcode</th>

        </tr>
        </thead>
    </table>
</div>

<!--<div id="feature-node-right-mid" class="esri-widget"></div>-->

<div id="feature-node-left-bottom" class="esri-widget">
    <p>Visualise COVID-19 spread using:</p>
    <label>
        <input type="radio" name="renderer" value="HEAT" checked />
        Heatmap
    </label> <br />

    <label>
        <input type="radio" name="renderer" value="DOTS" />
        Dots
    </label> <br />
    <br />

    <label>
        <input type="checkbox" id="postcodeLayer" checked> Postcode Boundaries
    </label>

</div>

<div id="feature-node-right-bottom" class="esri-widget">
    <table>
        <tbody>
        <tr>
            <td>Total tests (UK):</td>
            <td>{{ count_total_exp }}</td>
        </tr>
        <tr>
            <td>Total positive (UK):</td>
            <td>{{ count_pos_exp }}</td>
        </tr>
        <tr>
            <td>Total negative (UK):</td>
            <td>{{ count_neg_exp }}</td>
        </tr>
        <tr>
            <td>Total patients tested (UK):</td>
            <td>{{ count_indiv_patients }}</td>
        </tr>
        </tbody>
    </table>
</div>

</body>
</html>