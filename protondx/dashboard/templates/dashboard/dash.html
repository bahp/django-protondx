<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">

    <title>COVID-19 Dashboard</title>

    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'dashboard/layout.css' %}">

    <link rel="stylesheet" href="https://js.arcgis.com/4.15/esri/themes/dark/main.css">
    <script src="https://js.arcgis.com/4.15/"></script>

    <script>
        require([
            "esri/Map",
            "esri/views/MapView",
            "esri/geometry/Extent",
            "esri/layers/FeatureLayer",
            "esri/renderers/DotDensityRenderer",
            "esri/renderers/SimpleRenderer",
            "esri/widgets/Home",
            "esri/widgets/Legend",
            "esri/widgets/Expand",
            "esri/widgets/Fullscreen",
            "esri/widgets/Search",
        ], function(Map,
                    MapView,
                    Extent,
                    FeatureLayer,
                    DotDensityRenderer,
                    SimpleRenderer,
                    Home,
                    Legend,
                    Expand,
                    Fullscreen,
                    Search,) {

            // Map view
            const map = new Map({
                basemap: "dark-gray-vector"
            });

            const baseMap = new MapView({
                container: "viewDiv",
                map: map,
                center: [-2.89479, 54.093409],
                zoom: 5
            });

            // //////
            // renderers for postcode map
            // //////

            // density renderer
            const densityRenderer = {
                type: "dot-density",
                dotValue: 1,  // 1 dot = 1,000 people when the view.scale is 1:1,000,000
                referenceScale: 10000,
                legendOptions: {
                    unit: "people"
                },
                attributes: [
                    {
                        field: "OBJECTID",
                        label: "Postcode DB PK",
                        color: "red"
                    },
                ],
                outline: {
                    width: 0.1,
                    color: [0, 0, 0, 0.4],
                }
            };

            // dot renderer
            const dotRenderer = {
                type: "simple",
                symbol: {
                    type: "simple-marker",
                    size: 6,
                    color: "red",
                },
            };

            // postcode map and popup
            const popupPostcode = {
                title: "{NAME_1}, {POSTCODE_1}",
                content: "<table> <tbody>" +
                    "<tr> <td style=\"padding:0 15px 0 0;\">Total Cases:</td> <td>{{ post_code_query.total }}</td> </tr>" +
                    "<tr> <td>Positive:</td> <td>{{ post_code_query.positive }}</td> </tr>" +
                    "<tr> <td>Negative:</td> <td>{{ post_code_query.negative }}</td> </tr>" +
                    "<tr> <td>Patients:</td> <td>{{ post_code_query.patients }}</td> </tr>" +
                    "</tbody> </table>"
            };

            // postcode layer
            let postcodes = new FeatureLayer({
                url: "https://services.arcgis.com/dvWpUrMTxKmay5qM/arcgis/rest/services/PCSector%20with%20Regions/FeatureServer",
                outFields: ["POSTCODE_1", "NAME_1", "OBJECTID"],
                popupTemplate: popupPostcode,
                renderer: densityRenderer,
                title: "Postcode Database IDs",
            });

            //postcode popup
            baseMap.popup = {
                dockEnabled: true,
                dockOptions: {
                    buttonEnabled: false,
                    breakpoint: false
                }
            };

            //renderer selection w/ radio
            let radios = document.getElementsByName("renderer");
            for (let i = 0; i < radios.length; i++) {
                radios[i].addEventListener("change", function(event) {
                    const fieldName = event.target.value;
                    if (fieldName === "DENSITY") {
                        postcodes.renderer = densityRenderer;
                    }
                    if (fieldName === "DOTS") {
                        postcodes.renderer = dotRenderer;
                    }
                });
            }


            //Home button widget to reset view
            const homeWidget = new Home({
                view: baseMap
            });


            // Search widget
            const extent = new Extent({
                spatialReference: {
                    wkid: 4326
                },
                xmin: -8.64999581199993,
                xmax: 1.76294150100006,
                ymin: 49.864679134,
                ymax: 60.8607873510001
            });

            const search = new Search({
                view: baseMap,
                locationEnabled: true,
            });


            // fullscreen widget
            const fullscreen = new Fullscreen({
                view: baseMap
            });


            // add views and widgets
            map.add(postcodes);
            baseMap.ui.add(fullscreen, "bottom-right");
            baseMap.ui.add(homeWidget, "top-left");
            baseMap.ui.add(search, "top-right");
            baseMap.ui.add(
                [
                    new Expand({
                        view: baseMap,
                        content: new Legend({ view: baseMap }),
                        group: "top-left",
                        expanded: true
                    }),
                ],
                "top-left"
            );
        });
    </script>
</head>
<body>

<div id="viewDiv"></div>

<div id="feature-node-right-top" class="esri-widget"></div>

<div id="feature-node-right-mid" class="esri-widget"></div>

<div id="feature-node-left-bottom" class="esri-widget">
    <p>Visualise COVID-19 spread using:</p>
    <label>
        <input type="radio" name="renderer" value="DENSITY" checked />
        Heatmap
    </label> <br />

    <label>
        <input type="radio" name="renderer" value="DOTS" />
        Dots
    </label> <br />

</div>

<div id="feature-node-right-bottom" class="esri-widget">
    <table>
        <tbody>
        <tr>
            <td>Total tests (UK):</td>
            <td>{{ count_total_exp }}</td>
        </tr>
        <tr>
            <td>Total positive (UK):</td>
            <td>{{ count_pos_exp }}</td>
        </tr>
        <tr>
            <td>Total negative (UK):</td>
            <td>{{ count_neg_exp }}</td>
        </tr>
        <tr>
            <td>Total patients tested (UK):</td>
            <td>{{ count_indiv_patients }}</td>
        </tr>
        </tbody>
    </table>
</div>

</body>
</html>



<!--Form to query postcode information from our database-->

<!--    <form method="post">-->
<!--        {% csrf_token %}-->
<!--        {{ form.as_p }}-->
<!--        <button type="submit">Submit</button>-->
<!--    </form>-->

<!--    <h1>{{ post_code_query }}</h1>-->